# @epdoc/launchgen

> This tool is part of the [`@epdoc/tools`](../../README.md) repository.

Generate or update a `launch.json` file for use with VSCode. This script is designed to work with both Deno and Node.js
projects, automatically detecting the runtime and generating the appropriate launch configurations.

## Features

- **Automatic Runtime Detection:** Detects whether you are using a Deno or Node.js project, based on the presence of
  `deno.json` or `package.json`. Note that this script only runs on Deno.
- **Test File Discovery:** Walks the project folder and adds launch configurations for each test file found. See
  [File Naming Conventions](#file-naming-conventions) for more details.
- **Customizable Configurations:** Add custom launch configurations using a `launch.config.json` file.
- **Monorepo Support:** Works with monorepos by reading the `workspace` or `workspaces` property in your `deno.json` or
  `package.json`. It also supports glob patterns for discovering workspaces.
- **Preserves Manual Configurations:** Any existing launch configurations that were not generated by this script will be
  preserved.
- **Extensible:** The `LaunchGenerator` class is designed to be extended, allowing you to customize its behavior.

## Requirements

- Deno 2.4+
- A VSCode project (`.vscode` folder in the project root).
- Use of `deno.json` or `project.json` files. JSONC is not supported.

## Installation

First, you need to get the source code. You can either clone the repository or download the source code as a zip file.

```bash
git clone https://github.com/epdoc/tools.git
cd tools/packages/launchgen
```

To make the `launchgen` script globally available, you can install it using the following command:

```bash
deno task install
```

This will install the script as `launchgen` in your Deno installation's `bin` directory. Make sure that your Deno `bin`
directory is in your system's `PATH`.

## Usage

Once installed, you can run the script from anywhere in your terminal:

```bash
launchgen
```

### Direct Execution

If you prefer not to install the script globally, you can execute it directly from your terminal after making it
executable:

```bash
./launchgen.ts
```

Alternatively, you can use `deno run`:

```bash
deno run -A launchgen.ts
```

### VSCode Action Button

Add launchgen as a [VS Code Action Button](https://github.com/SeunLanLege/vscode-action-buttons):

```json
"actionButtons": {
  "commands": [
    {
      "name": "$(rocket) Launchgen",
      "command": "/Users/jpravetz/.deno/bin/launchgen",
      "tooltip": "Run the launchgen script to build a launch.json file",
      "useVsCodeApi": false,
      "singleInstance": true,
      "focus": true
    }
  ],
},
```

### As a Module

You can also import the `LaunchGenerator` class into your own scripts to extend its functionality or integrate it into
other workflows.

```typescript
import { LaunchGenerator } from './launchgen.ts';

const projectRoot = Deno.cwd();
const generator = new LaunchGenerator(projectRoot);
await generator.run();
```

## File Naming Conventions

The script will automatically discover and generate launch configurations for files with the following naming
conventions:

- `*.test.ts`
- `*.run.ts`
- `*.test.js`
- `*.run.js`

## Configuration

## Default Configuration

`launchgen` provides a default configuration for your `launch.json` file, even if you don't have a `launch.config.json`
file. The default values are:

```json
{
  "port": 9229,
  "console": "internalConsole",
  "tests": {
    "runtimeArgs": ["--check"]
  }
}
```

You can override these defaults by creating a `launch.config.json` file in your project root and specifying your own
values.

The script works out of the box for most projects, but you can create a `launch.config.json` file in your project root
for more advanced configurations.

### `deno.json`

You can control which files are included and excluded from the test search by using the `tests` object in your
`deno.json` file. Note that the `tests` entry is a standard feature of `deno.json` and may be used by other Deno tools.

**Example `deno.json`:**

```json
{
  "tests": {
    "include": ["src", "tests"],
    "exclude": ["src/ignore", "tests/data"]
  }
}
```

- `tests.include`: An array of paths to include in the search for test files. If not specified, the script will use the
  `workspace` or `workspaces` property, or default to the project root.
- `tests.exclude`: An array of paths to exclude from the search. These can be files or directories, and glob patterns
  are supported. By default, all hidden files and directories (those starting with a `.`) are excluded.

### Monorepo Configuration

For monorepos, you can define workspaces in your `deno.json` or `package.json` file. The script will then search for
test files within each workspace.

**Example `deno.json` with workspaces:**

```json
{
  "workspace": ["packages/*"]
}
```

The script will expand the glob pattern and look for a `deno.json` file in each of the matching directories. If a
`deno.json` file is found, the directory is treated as a workspace.

### `launch.config.json`

This file allows you to define global settings, custom arguments for auto-discovered tests, and custom launch
configuration groups.

**Example `launch.config.json`:**

```json
{
  "port": 9229,
  "console": "internalConsole",
  "tests": {
    "runtimeArgs": ["--check"]
  },
  "groups": [
    {
      "program": "src/main.ts",
      "runtimeArgs": ["run", "--inspect-brk", "-A"],
      "scriptArgs": ["--some-default-arg"],
      "scripts": [
        "",
        "-h",
        "--verbose"
      ]
    }
  ]
}
```

**Global Settings:**

- `port`: The port to use for debugging. Defaults to `9229`.
- `console`: Controls where the debuggee's (the application being debugged) **output (stdout/stderr)** will appear. The
  value `internalConsole` directs the output to the **VS Code Debug Console**. Other common values include:
  - `integratedTerminal`: Uses VS Code's built-in terminal.
  - `externalTerminal`: Opens a new external terminal window.

If the application requires **user input** via `stdin` (like a command-line utility), the user **should** change console
to `integratedTerminal` or `externalTerminal`, as the `internalConsole` cannot handle standard input.

A user might prefer `integratedTerminal` to keep the application's output separate from the Debug Console's internal
messages (like logpoints or variable evaluations).

**Auto-Discovered Test Settings (`tests`):**

- `runtimeArgs`: An array of arguments to be passed to the runtime for all auto-discovered test files. These arguments
  are appended to the default arguments. This is useful for applying a consistent set of flags (e.g., `--check`) across
  all your tests.

**Custom Group Settings (`groups`):**

Use groups when you need to manually define a launch configuration for a specific executable or create multiple launch
configurations for a single script with different arguments.

- `program`: The path to the script to be executed.
- `runtimeArgs`: An array of arguments to be passed to the runtime (`deno` or `node`). For Deno, this is where you would
  put permissions like `-A` or `--allow-net`. For Node, you might include flags like `--experimental-modules`.
- `scriptArgs`: An array of default arguments to be passed to the script itself.
- `scripts`: An array of additional arguments to be passed to the script. A separate launch configuration will be
  created for each entry in this array.

### Default Arguments

The final `runtimeArgs` for an auto-discovered test file is a combination of the script-specific defaults and the global
arguments defined in `launch.config.json`.

- **Deno:** For `*.test.ts` or `*.run.ts` files, the default `runtimeArgs` are `["test", "--inspect-brk", "-A"]`. The
  final arguments will be `["test", "--inspect-brk", "-A", "<path_to_file>", ...tests.runtimeArgs]`.
- **Node.js:** For `*.test.js` or `*.run.js` files, there are no default `runtimeArgs`. The final arguments will be
  `["<path_to_file>", ...tests.runtimeArgs]`.

The arguments from `tests.runtimeArgs` are always added after the default arguments and the file path.

The provided properties from a VS Code `launch.json` file are used to configure how the debugger launches and attaches
to a process, specifically for Node.js debugging given the typical use of `port: 9229`.

## How it Works

- The script starts by looking for a `.vscode` folder to find the project root.
- It then checks for the presence of `deno.json` or `package.json` to determine the runtime.
- It reads configuration from `deno.json`, `package.json`, and `launch.config.json` (if they exist).
- It reads the existing `launch.json` file (if it exists) and filters out any previously generated configurations. This
  is done by checking for the presence of an `env` property with `LAUNCHGEN` set to `'true'`. Any configuration that
  does not have this property will be preserved.
- It walks the workspace directories, adhering to the `tests` entries in `deno.json`, and adds launch configurations for
  any test or run files it finds. Any global test arguments from `launch.config.json` are applied here.
- It adds any custom launch configurations defined in the `groups` section of `launch.config.json`.
- Finally, it writes the updated configurations back to the `launch.json` file.

## License

MIT
